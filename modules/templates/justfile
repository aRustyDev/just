# Template management using GitHub Gists
# Each gist contains a justfile that handles its own installation

gists := """
    {
        "common": "3d2a93d76c023eba50a2d037e36cf28e",
        "github": "c60f1e34d9d2afdc78f9383abad01108",
        "github_workflows": "a1c2a0a87b3fd9ca22f369198058b8f4",
        "github_rulesets": "ddb7525aa0b31d30415cbce2eb36bf59",
        "prs": "c890c91c827d4e740d14bd7f6aaa1f3a",
        "issues": "dc4f23113068929cd248a2bfeffa9ed5",
        "obsidian": "f23693cb0b5e49d592beef42e318f060",
        "obsidian_templates": "9d81174c1a85b6052407efd1f384f672",
        "obsidian_fileclasses": "989c0b071a3572073652aea8ed8c2809",
        "obsidian_plugin_zettelflow": "1ece174a91f4c790eb86b9d7bfb7789d",
        "obsidian_plugin_updatetimeonedit": "e7dfc35e1685e217116e9257655e34ed",
        "obsidian_plugin_templater": "bb535c91f4ad51bd8d30515c1eaf619c",
        "obsidian_plugin_tableeditor": "65e5ddeaaedd0ce9e561660f6522cbeb",
        "obsidian_plugin_tasks": "9b54978f99897045280cf16b8f1c802d",
        "obsidian_plugin_reminder": "8d2174e7887114259eae16896984b9ee",
        "obsidian_plugin_linter": "e340011f0b21b3ca5931496b868a5472",
        "obsidian_plugin_kanban": "1fe702fd8855384129967005c0819973",
        "obsidian_plugin_git": "fd6e1415182a85907ca5e3671c18ee68",
        "obsidian_plugin_frontmattertitle": "d5869c2cb401dac8af94b6bd27838a82",
        "obsidian_plugin_checklists": "849fb957a3950f15b8f4a86cdd406ebb",
        "obsidian_plugin_charts": "1f3b8ac98e9d804769f5c8dd5fab9858",
        "obsidian_plugin_metadatamenu": "ec63df54308019ddcca5058c4a340b50",
        "obsidian_plugin_mermaidtools": "84929766f614e94d5e24175620b8d0aa",
        "obsidian_plugin_graphanalysis": "4bd3a55b3b61f5a10629263492fa22b3",
        "obsidian_plugin_dataview": "643205925a505323e62a8f10e4c4c326",
        "obsidian_plugin_calendar": "dc72e5551971734ee931e170a00ae227",
        "obsidian_plugin_excalidraw": "1b04fc968abf7c21165ae162fc32a2f9"
    }
    """
cwd := invocation_directory()

[private]
default:
    @just --list --unsorted

# ============================================================================
# Core Template Operations
# ============================================================================
# Apply a template from a gist (clones gist and runs its justfile)

# Use --dry-run to preview what would be installed
[group('template')]
apply-gist gist_id *FLAGS:
    #!/usr/bin/env bash
    set -euo pipefail

    # Use INSTALL_DIR from environment if set, otherwise use invocation directory
    install_dir="${INSTALL_DIR:-{{ cwd }}}"

    gist_hash=$(jq -r --null-input '{{ replace_regex(gists, "\\s", "") }} | .{{ gist_id }}')
    if [[ -z "$gist_hash" || "$gist_hash" == "null" ]]; then
        echo "Error: Unknown gist '{{ gist_id }}'"
        echo "Available gists:"
        jq -r --null-input '{{ replace_regex(gists, "\\s", "") }} | keys | .[]' | sort
        exit 1
    fi

    # Check for --dry-run flag
    recipe="install"
    for flag in {{ FLAGS }}; do
        if [[ "$flag" == "--dry-run" ]]; then
            recipe="dry-run"
        fi
    done

    tmp_dir=$(mktemp -d)
    trap "rm -rf $tmp_dir" EXIT

    echo "Cloning gist {{ gist_id }}..."
    gh gist clone "$gist_hash" "$tmp_dir" -- --quiet

    # Find the justfile (could be named <gist_id>.just or justfile)
    justfile=""
    for f in "$tmp_dir"/*.just "$tmp_dir/justfile"; do
        if [[ -f "$f" ]]; then
            justfile="$f"
            break
        fi
    done

    if [[ -z "$justfile" ]]; then
        echo "Error: No justfile found in gist {{ gist_id }}"
        exit 1
    fi

    echo "Running recipe '$recipe'..."
    INSTALL_DIR="$install_dir" just -f "$justfile" "$recipe"

# Remove installed templates from a gist

# Use --dry-run to preview what would be removed
[group('template')]
remove-gist gist_id *FLAGS:
    #!/usr/bin/env bash
    set -euo pipefail

    # Use INSTALL_DIR from environment if set, otherwise use invocation directory
    install_dir="${INSTALL_DIR:-{{ cwd }}}"

    gist_hash=$(jq -r --null-input '{{ replace_regex(gists, "\\s", "") }} | .{{ gist_id }}')
    if [[ -z "$gist_hash" || "$gist_hash" == "null" ]]; then
        echo "Error: Unknown gist '{{ gist_id }}'"
        echo "Available gists:"
        jq -r --null-input '{{ replace_regex(gists, "\\s", "") }} | keys | .[]' | sort
        exit 1
    fi

    # Check for --dry-run flag
    dry_run=""
    for flag in {{ FLAGS }}; do
        if [[ "$flag" == "--dry-run" ]]; then
            dry_run="true"
        fi
    done

    tmp_dir=$(mktemp -d)
    trap "rm -rf $tmp_dir" EXIT

    echo "Cloning gist {{ gist_id }}..."
    gh gist clone "$gist_hash" "$tmp_dir" -- --quiet

    # Find the justfile (could be named <gist_id>.just or justfile)
    justfile=""
    for f in "$tmp_dir"/*.just "$tmp_dir/justfile"; do
        if [[ -f "$f" ]]; then
            justfile="$f"
            break
        fi
    done

    if [[ -z "$justfile" ]]; then
        echo "Error: No justfile found in gist {{ gist_id }}"
        exit 1
    fi

    if [[ -n "$dry_run" ]]; then
        echo "Would run 'uninstall' recipe (dry-run)..."
        INSTALL_DIR="$install_dir" just -f "$justfile" --dry-run uninstall
    else
        echo "Running recipe 'uninstall'..."
        INSTALL_DIR="$install_dir" just -f "$justfile" uninstall
    fi

# List available template gists
[group('template')]
list-gists filter="":
    #!/usr/bin/env bash
    echo "=== Available Template Gists ==="
    if [[ -z "{{ filter }}" ]]; then
        jq -r --null-input '{{ replace_regex(gists, "\\s", "") }} | keys | .[]' | sort
    else
        jq -r --null-input '{{ replace_regex(gists, "\\s", "") }} | keys | .[]' | grep -i "{{ filter }}" | sort
    fi

# ============================================================================
# GitHub Repository Templates
# ============================================================================

# Initialize a complete GitHub repository with all templates
[group('github')]
init-github: _mktree-github
    INSTALL_DIR="{{ cwd }}" just apply-gist common
    INSTALL_DIR="{{ cwd }}" just apply-gist github
    INSTALL_DIR="{{ cwd }}" just apply-gist github_workflows
    INSTALL_DIR="{{ cwd }}" just apply-gist github_rulesets
    INSTALL_DIR="{{ cwd }}" just apply-gist issues
    INSTALL_DIR="{{ cwd }}" just apply-gist prs

# Apply only common files (CODE_OF_CONDUCT, CONTRIBUTING, etc.)
[group('github')]
init-github-common: _mktree-github
    INSTALL_DIR="{{ cwd }}" just apply-gist common

# Apply only GitHub config files (FUNDING, labels, release-drafter)
[group('github')]
init-github-config: _mktree-github
    INSTALL_DIR="{{ cwd }}" just apply-gist github

# Apply only GitHub workflows
[group('github')]
init-github-workflows: _mktree-github
    INSTALL_DIR="{{ cwd }}" just apply-gist github_workflows

# Apply only GitHub rulesets
[group('github')]
init-github-rulesets: _mktree-github
    INSTALL_DIR="{{ cwd }}" just apply-gist github_rulesets

# Apply only issue templates
[group('github')]
init-github-issues: _mktree-github
    INSTALL_DIR="{{ cwd }}" just apply-gist issues

# Apply only PR templates
[group('github')]
init-github-prs: _mktree-github
    INSTALL_DIR="{{ cwd }}" just apply-gist prs

[group('github')]
[private]
_mktree-github:
    mkdir -p "{{ cwd }}"/.github/{rulesets,workflows,ISSUE_TEMPLATE,pull-requests}

# ============================================================================
# Obsidian Vault Templates
# ============================================================================

# Initialize a complete Obsidian vault with all configs and plugins
[group('obsidian')]
init-obsidian: _mktree-obsidian init-obsidian-core init-obsidian-templates init-obsidian-fileclasses init-obsidian-plugins

# Apply only core Obsidian config files
[group('obsidian')]
init-obsidian-core: _mktree-obsidian
    INSTALL_DIR="{{ cwd }}" just apply-gist obsidian

# Apply only Obsidian note templates
[group('obsidian')]
init-obsidian-templates: _mktree-obsidian
    INSTALL_DIR="{{ cwd }}" just apply-gist obsidian_templates

# Apply only Obsidian fileclass definitions
[group('obsidian')]
init-obsidian-fileclasses: _mktree-obsidian
    INSTALL_DIR="{{ cwd }}" just apply-gist obsidian_fileclasses

# Apply all Obsidian plugin configs
[group('obsidian')]
[group('plugin')]
[parallel]
init-obsidian-plugins: _mktree-obsidian
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin calendar
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin charts
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin checklists
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin dataview
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin excalidraw
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin frontmattertitle
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin git
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin graphanalysis
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin kanban
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin linter
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin mermaidtools
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin metadatamenu
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin reminder
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin tableeditor
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin tasks
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin templater
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin updatetimeonedit
    INSTALL_DIR="{{ cwd }}" just init-obsidian-plugin zettelflow

# Apply a specific Obsidian plugin config
[group('obsidian')]
[group('plugin')]
init-obsidian-plugin plugin: _mktree-obsidian
    INSTALL_DIR="${INSTALL_DIR:-{{ cwd }}}" just apply-gist "obsidian_plugin_{{ plugin }}"

[group('obsidian')]
[private]
_mktree-obsidian:
    mkdir -p "{{ cwd }}"/.obsidian/{fileClasses,plugins,templates}
